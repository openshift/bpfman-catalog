# Use alpine for the build stage with shell support.
FROM alpine:latest AS builder

# Install OPM from the official image.
COPY --from=quay.io/operator-framework/opm:v1.54.0 /bin/opm /bin/opm

# Create containers policy configuration. Use standard development policy
# that matches Fedora's default configuration.
RUN mkdir -p /etc/containers && \
    echo '{"default":[{"type":"insecureAcceptAnything"}],"transports":{"docker-daemon":{"":[{"type":"insecureAcceptAnything"}]}}}' > /etc/containers/policy.json

ARG TEMPLATE_FILE

WORKDIR /workspace

COPY templates/${TEMPLATE_FILE} ./template.yaml

# Generate catalog for single template. Use symlink to make BuildKit
# mount accessible to OPM. This allows OPM to read credentials without
# copying them to the filesystem.
RUN --mount=type=secret,id=dockerconfig,target=/run/secrets/auth.json \
    mkdir -p /root/.docker && \
    ln -s /run/secrets/auth.json /root/.docker/config.json && \
    /bin/opm alpha render-template basic \
        --migrate-level=bundle-object-to-csv-metadata \
        -o yaml ./template.yaml > catalog.yaml && \
    rm -f /root/.docker/config.json

FROM scratch
COPY --from=builder /workspace/catalog.yaml /catalog.yaml
